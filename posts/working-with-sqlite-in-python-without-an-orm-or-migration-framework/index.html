<!DOCTYPE html><html> <head><meta charset="utf-8"><title>Working with SQLite in Python without an ORM or migration framework | Hi, I'm Nhân</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/theme/css/font.css"><link rel="stylesheet" href="/theme/css/pygment.css"><link rel="stylesheet" href="/theme/css/main.css"><link rel="stylesheet" href="/theme/css/article.css"><meta name="twitter:card" content="summary"><meta name="twitter:creator" content="@nhanbt"><meta property="og:title" content="Working with SQLite in Python without an ORM or migration framework"><meta property="og:description" content="Some notes on handling migrations, linking the latest SQLite, and sane driver defaults."><meta property="og:image" content="../../images/byte_databases.jpg"></head> <!--

Why hello there, source viewer. Here's a dragon for no particular reason:

       ^                       ^
       |\   \        /        /|
      /  \  |\__  __/|       /  \_
     / /\ \ \ _ \/ _ /      /    \_
    / / /\ \ {*}\/{*}      /  / \ \_
    | | | \ \( (00) )     /  // |\ \_
    | | | |\ \(V""V)\    /  / | || \|
    | | | | \ |^--^| \  /  / || || ||
   / / /  | |( WWWW__ \/  /| || || ||
  | | | | | |  \______\  / / || || ||
  | | | / | | )|______\ ) | / | || ||
  / / /  / /  /______/   /| \ \ || ||
 / / /  / /  /\_____/  |/ /__\ \ \ \ \_
 | | | / /  /\______/    \   \__| \ \ \_
 | | | | | |\______ __    \_    \__|_| \_
 | | ,___ /\______ _  _     \_       \  |
 | |/    /\_____  /    \      \__     \ |    /\_
 |/ |   |\______ |      |        \___  \ |__/  \_
 v  |   |\______ |      |            \___/     |
    |   |\______ |      |                    __/
     \   \________\_    _\               ____/
   __/   /\_____ __/   /   )\_,      _____/
  /  ___/  \____/  ___/___)    \______/
  VVV  V        VVV  V

(ripped off from http://www.retrojunkie.com/asciiart/myth/dragons.htm)

--> <body> <div id="main"> <header> <h1 id="site-name"><a href="/">Hi, I'm Nhân</a></h1> <h2 id="site-subtitle">and this is my humble corner on the intertubes.</h2> </header> <nav> <ul class="navbar" id="left-navbar"> <li><a href="/">Blog</a></li> <li><a href="../../about/">About</a></li> <li><a href="../../projects/">Projects</a></li> </ul> <ul class="navbar" id="right-navbar"> <li><a href="https://cv.imnhan.com">CV</a></li> <li><a href="/feeds/atom.xml">Feed</a></li> </ul> <div class="clearfix"></div> </nav> <div id="content"> <div class="article-content"> <article> <h1 class="article-title"> Working with SQLite in Python without an ORM or migration framework </h1> <time datetime="2022-01-30 14:11:00+07:00"> January 30, 2022 </time> <p><img alt="byte-magazine-databases" src="/images/byte_databases.jpg"> <em><a href="https://archive.org/details/byte-magazine">(seriously though, <span class="caps">BYTE</span> covers are the&nbsp;best)</a></em></p> <p>I learned about SQLite&rsquo;s user_version pragma some time ago from a comment on Hacker News (as one does). Not sure which comment it was specifically, but it went something <a href="https://news.ycombinator.com/item?id=23510382">like this</a>:</p> <blockquote> <p>One thing you can look into using is the SQLite user_version pragma. We use this right now to roll our own migrators and it&rsquo;s light years better than how migrators work for Entity Framework, et.&nbsp;al.</p> <p><a href="https://www.sqlite.org/pragma.html#pragma_user_version">https://www.sqlite.org/pragma.html#pragma_user_version</a></p> </blockquote> <p>I&rsquo;d wanted to try working without an <span class="caps">ORM</span> for a while, and this comment gave me the final missing piece: a straightforward approach to <span class="caps">SQL</span> migrations that I can trivially implement. Obviously, I had to try it out on my latest <a href="https://sr.ht/~nhanb/pytaku/">pet project</a>. Here I&rsquo;ll outline some of my&nbsp;findings.</p> <h2 id="apsw-as-the-driver"><span class="caps">APSW</span> as the driver<a class="headerlink" href="#apsw-as-the-driver" title="Permanent link">#</a></h2> <p>Using <a href="https://rogerbinns.github.io/apsw/">apsw</a> instead of the standard library&rsquo;s sqlite3 package has a couple of&nbsp;advantages:</p> <h3 id="its-easy-to-link-against-the-latest-sqlite3-version">It&rsquo;s easy to link against the latest sqlite3 version<a class="headerlink" href="#its-easy-to-link-against-the-latest-sqlite3-version" title="Permanent link">#</a></h3> <p>I originally ran pytaku on a cheap Vietnamese <span class="caps">VPS</span> provider, which only offered Ubuntu 12.04. This came with a relatively old sqlite3 version that lacked <span class="caps">UPSERT</span> support (probably among other things that I forgot). I guess it&rsquo;s possible to compile a custom python version that links to a newer sqlite, but that would defeat the purpose of pytaku being an easy-to-deploy program. Apsw, on the other hand, provides a pip <a href="https://rogerbinns.github.io/apsw/download.html#i-really-want-to-use-pip">one-liner</a> that compiles and links to the latest sqlite. (still kinda bad, but it&rsquo;s less bad than compiling custom&nbsp;python)</p> <h3 id="it-has-the-same-defaults-as-upstream-sqlite">It has the same defaults as upstream sqlite<a class="headerlink" href="#it-has-the-same-defaults-as-upstream-sqlite" title="Permanent link">#</a></h3> <p>Python stdlib&rsquo;s <code>sqlite3</code> has a few default configurations that deviate from sqlite&rsquo;s. A couple of things that actually bit me&nbsp;are:</p> <ul> <li>autocommit mode is off by&nbsp;default</li> <li><code>executescript()</code> automatically issues a <code>COMMIT</code> statement</li> </ul> <p>To be fair, both of them are written in the docs, and these custom defaults are probably to maintain consistency with <a href="https://www.python.org/dev/peps/pep-0249/"><span class="caps">PEP</span> 249</a>. Still, as I was learning sqlite, it&rsquo;s frustrating to jump between sqlite docs and python docs to interpret the correct behavior at times. Apsw does none of those things: it&rsquo;s simply an unopinionated, honest-to-god python binding to&nbsp;sqlite.</p> <p>To be completely honest though, in the long run it seems more reasonable to learn the pysqlite3 <span class="caps">API</span> so that I can avoid an extra dependency. I&rsquo;m also now using Debian 11 which has a reasonably recent sqlite, so the compilation advantange is no longer that&nbsp;great.</p> <h2 id="a-minimum-viable-db-migration-scheme">A minimum viable <span class="caps">DB</span> migration scheme<a class="headerlink" href="#a-minimum-viable-db-migration-scheme" title="Permanent link">#</a></h2> <p>With <a href="https://github.com/nhanb/pytaku/blob/65a6c08128ebbc2b7d33a6b043798c69ac7dfebe/src/pytaku/database/migrator.py">&lt;100 lines</a> of python, I ended up with a migrator&nbsp;that:</p> <ul> <li>Finds migration files in the form of <code>./migrations/mXXXX.sql</code></li> <li>Uses <code>user_version</code> pragma to figure out what migrations are&nbsp;pending</li> <li>Is forward-only&mdash;I did say that this is minimally viable didn&rsquo;t I&nbsp;;)</li> </ul> <p>Coming from Django, I missed a definitive place to see the latest definition of the whole db (which, in Django, is the models file). That&rsquo;s why I set up the migrator to always write the latest db definition out to a file using <a href="https://github.com/nhanb/pytaku/blob/65a6c08128ebbc2b7d33a6b043798c69ac7dfebe/src/pytaku/database/migrator.py#L44-L51"><code>sqlite3 &lt;db_file&gt; .schema &gt; latest_schema.sql</code></a>, and keep that file <a href="https://github.com/nhanb/pytaku/blob/65a6c08128ebbc2b7d33a6b043798c69ac7dfebe/src/pytaku/database/migrations/latest_schema.sql">in version control</a>:</p> <div class="highlight"><pre><span></span><code><span class="c1">-- This file is auto-generated by the migration script</span>
<span class="c1">-- for reference purposes only. DO NOT EDIT.</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">site</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">cover_ext</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">chapters</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">alt_names</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">descriptions</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">)),</span><span class="w"> </span><span class="n">is_webtoon</span><span class="w"> </span><span class="nb">boolean</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">false</span><span class="p">,</span><span class="w"> </span><span class="n">descriptions_format</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="k">unique</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span>
<span class="w">    </span><span class="n">username</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">unique</span><span class="p">,</span>
<span class="w">    </span><span class="n">password</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">))</span>
<span class="p">);</span>
<span class="p">[...]</span>
</code></pre></div> <p>Now to address the elephant in the room: SQLite has&hellip; limited <span class="caps">ALTER</span> <span class="caps">TABLE</span> capabilities. The upside is it&rsquo;s <a href="https://www.sqlite.org/lang_altertable.html">well-documented</a>. What this means in practice is that sometimes an otherwise simple <code>ALTER TABLE</code> in other <span class="caps">RDBMS</span>-es will require more manual gymnastics in SQLite: you&rsquo;ll need to create a new table with the desired properties, copy existing data over to the new table, then drop the old table. There are subtle bear traps in the specific order of steps to take, but thankfully the docs, again, deliver: as long as you follow the <a href="https://www.sqlite.org/lang_altertable.html#otheralter">12 steps</a> correctly, you won&rsquo;t mess up your data. It sounds intimidating but it&rsquo;s not <em>that</em> bad. Here&rsquo;s a specific example from pytaku where I removed a <span class="caps">FOREIGN</span> <span class="caps">KEY</span>&nbsp;constraint:</p> <div class="highlight"><pre><span></span><code><span class="c1">-- Remove foreign key from &quot;read&quot; table pointing to &quot;chapter&quot;.</span>
<span class="c1">-- So we can, say, mark all chapters of a title as read even if some of those</span>
<span class="c1">-- chapters haven&#39;t been created.</span>

<span class="n">pragma</span><span class="w"> </span><span class="n">foreign_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w"> </span><span class="c1">-- to let us do anything at all</span>
<span class="k">begin</span><span class="w"> </span><span class="k">transaction</span><span class="p">;</span>

<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">new_read</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">site</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">title_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="c1">-- nullable to accomodate existing mangadex rows, urgh.</span>
<span class="w">    </span><span class="n">chapter_id</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">)),</span>

<span class="w">    </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="k">unique</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">,</span><span class="w"> </span><span class="n">title_id</span><span class="p">,</span><span class="w"> </span><span class="n">chapter_id</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">new_read</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">read</span><span class="p">;</span>
<span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">read</span><span class="p">;</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">new_read</span><span class="w"> </span><span class="k">rename</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">read</span><span class="p">;</span>

<span class="n">pragma</span><span class="w"> </span><span class="n">foreign_key_check</span><span class="p">;</span>
<span class="k">commit</span><span class="p">;</span>
<span class="n">pragma</span><span class="w"> </span><span class="n">foreign_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">on</span><span class="p">;</span>
</code></pre></div> <p>Besides the boilerplaty dance with foreign_key pragmas and transactions, all I had to do was copy the existing table definition from the aforementioned latest_schema.sql file, tweak it to my desired state, then do the table switcheroo. Again, the specific ordering of steps is important. I won&rsquo;t go into details, but I had actually tripped on a failure mode, which I then realized was already nicely warned against in the docs. <span class="caps">RTFM</span> is actually fine advice for projects that have good documentation, who would have&nbsp;thought?</p> <h2 id="recommended-sane-defaults">Recommended sane defaults<a class="headerlink" href="#recommended-sane-defaults" title="Permanent link">#</a></h2> <p>SQLite comes with some default settings that may be surprising for people coming from e.g. Postgres. Here are some tweaks that worked better for&nbsp;me.</p> <p><a href="https://sqlite.org/wal.html">Enable <span class="caps">WAL</span> mode</a>. This allows for concurrent readers, which is usually what you want from a web&nbsp;service.</p> <p><a href="https://www.sqlite.org/pragma.html#pragma_foreign_keys">Enforce foreign key constraints</a>. Yep, you read that right: SQLite doesn&rsquo;t enforce foreign key constraints by default. This is just one of the various consequences of SQLite being veeeeery lax about what you store. Another potential surprise is column types not being enforced, whose alternative only landed recently in the form of <a href="https://www.sqlite.org/stricttables.html"><span class="caps">STRICT</span> Tables</a>.</p> <p><a href="https://www.sqlite.org/c3ref/busy_timeout.html">Set a non-zero busytimeout</a>. Otherwise if a query is blocked, it will crash immediately instead of waiting for the blocking query to finish, no matter how short the wait&nbsp;is.</p> <h2 id="a-quick-note-on-sql-injection">A quick note on <span class="caps">SQL</span> injection<a class="headerlink" href="#a-quick-note-on-sql-injection" title="Permanent link">#</a></h2> <p><em>(or how to move on from the late&nbsp;90s)</em></p> <p>You don&rsquo;t need a full blown <span class="caps">ORM</span> to protect yourself against <span class="caps">SQL</span> injections. In fact, SQLite (and any sane <span class="caps">RDBMS</span> really) has built-in support for it called parameterized queries. Python&rsquo;s sqlite3 documentation also covers this, but the tl;dr&nbsp;is:</p> <div class="highlight"><pre><span></span><code><span class="c1"># Never compose your query with string interpolation like this:</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT foo FROM bar WHERE stuff = &#39;</span><span class="si">{</span><span class="n">user_input</span><span class="si">}</span><span class="s2">&#39;;&quot;</span><span class="p">)</span>

<span class="c1"># Use the parameter substitution API instead:</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT foo FROM bar WHERE stuff = ?;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_input</span><span class="p">,))</span>
</code></pre></div> <p>Congratulations! You now have better security hygiene than <a href="https://vnhacker.blogspot.com/2021/08/bkav-bi-hack-nhu-nao.html">Vietnam&rsquo;s &ldquo;leading&rdquo; cybersecurity firm</a>.</p> </article> </div> <h2 id="comments">Comments</h2> <div id="disqus_thread"> <button id="showCommentBtn">Show comments via Disqus</button> <noscript><br>(enable JavaScript first though)</noscript> </div> <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    // These need to be defined in the outermost scope, apparently.
    var disqus_shortname = 'nerdyweekly';
    var disqus_identifier = '/posts/working-with-sqlite-in-python-without-an-orm-or-migration-framework/';
    var disqus_url = '../../posts/working-with-sqlite-in-python-without-an-orm-or-migration-framework/';
    var disqus_title = 'Working with SQLite in Python without an ORM or migration framework';

    document.querySelector('#showCommentBtn').addEventListener('click', function (event) {
        // Immediate visual feedback is always good:
        event.target.disabled = true;
        event.target.innerHTML = 'Loading comments...';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    });
</script> </div> <footer> &copy; 2013–2023 Bùi Thành Nhân <br> Built with &#9829; and probably too much <a target="_blank" rel="noopener" href="https://www.alambe.vn/products/ca-phe-rang-xay-alambe-sai-gon">cà phê sữa đá</a>. <p class="easter-egg" style="display: none; font-size: .7em; margin: 0; color: var(--bg-color);"> Bored? Try entering the Konami code from your keyboard. </p> <script>
        document.querySelector('.easter-egg').style.display = 'block';
      </script> </footer> </div> <script src="/theme/konami.js"></script> </body> </html>