<!DOCTYPE html><html> <head><meta charset="utf-8"><title>I made my python webapp installable via pip | Hi, I'm Nhân</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/theme/css/font.css"><link rel="stylesheet" href="/theme/css/pygment.css"><link rel="stylesheet" href="/theme/css/main.css"><link rel="stylesheet" href="/theme/css/article.css"><meta name="twitter:card" content="summary"><meta name="twitter:creator" content="@nhanbt"><meta property="og:title" content="I made my python webapp installable via pip"><meta property="og:description" content="Running pip3 install pytaku now gives you all the tools you need 1 2 to deploy pytaku - a hobby webapp of mine - on a fresh Debian 11 server: pytaku-generate-config > pytaku.conf.json # generate config file pytaku-migrate # generate initial sqlite3..."><meta property="og:image" content="../../images/keyboard-warrior.jpg"></head> <!--

Why hello there, source viewer. Here's a dragon for no particular reason:

       ^                       ^
       |\   \        /        /|
      /  \  |\__  __/|       /  \_
     / /\ \ \ _ \/ _ /      /    \_
    / / /\ \ {*}\/{*}      /  / \ \_
    | | | \ \( (00) )     /  // |\ \_
    | | | |\ \(V""V)\    /  / | || \|
    | | | | \ |^--^| \  /  / || || ||
   / / /  | |( WWWW__ \/  /| || || ||
  | | | | | |  \______\  / / || || ||
  | | | / | | )|______\ ) | / | || ||
  / / /  / /  /______/   /| \ \ || ||
 / / /  / /  /\_____/  |/ /__\ \ \ \ \_
 | | | / /  /\______/    \   \__| \ \ \_
 | | | | | |\______ __    \_    \__|_| \_
 | | ,___ /\______ _  _     \_       \  |
 | |/    /\_____  /    \      \__     \ |    /\_
 |/ |   |\______ |      |        \___  \ |__/  \_
 v  |   |\______ |      |            \___/     |
    |   |\______ |      |                    __/
     \   \________\_    _\               ____/
   __/   /\_____ __/   /   )\_,      _____/
  /  ___/  \____/  ___/___)    \______/
  VVV  V        VVV  V

(ripped off from http://www.retrojunkie.com/asciiart/myth/dragons.htm)

--> <body> <div id="main"> <header> <h1 id="site-name"><a href="/">Hi, I'm Nhân</a></h1> <h2 id="site-subtitle">and this is my humble corner on the intertubes.</h2> </header> <nav> <ul class="navbar" id="left-navbar"> <li><a href="/">Blog</a></li> <li><a href="../../about/">About</a></li> <li><a href="../../projects/">Projects</a></li> </ul> <ul class="navbar" id="right-navbar"> <li><a href="https://cv.imnhan.com">CV</a></li> <li><a href="/feeds/atom.xml">Feed</a></li> </ul> <div class="clearfix"></div> </nav> <div id="content"> <div class="article-content"> <article> <h1 class="article-title"> I made my python webapp installable via pip </h1> <time datetime="2021-10-02 19:49:00+07:00"> October 02, 2021 </time> <p>Running <code>pip3 install pytaku</code> now gives you all the tools you need <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> <sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup> to deploy <a href="https://sr.ht/~nhanb/pytaku/">pytaku</a> - a hobby webapp of mine - on a fresh Debian 11&nbsp;server:</p> <div class="highlight"><pre><span></span><code>pytaku-generate-config<span class="w"> </span>&gt;<span class="w"> </span>pytaku.conf.json<span class="w">  </span><span class="c1"># generate config file</span>
pytaku-migrate<span class="w">  </span><span class="c1"># generate initial sqlite3 db, or migrate to new version</span>
pytaku<span class="w"> </span>-w<span class="w"> </span><span class="m">5</span><span class="w">  </span><span class="c1"># run main webapp using gunicorn on localhost:8000</span>
pytaku-scheduler<span class="w">  </span><span class="c1"># daemon that executes scheduled background tasks</span>

<span class="c1"># Optionally, run this to copy all static assets to a designated dir so your</span>
<span class="c1"># web server (nginx/caddy/etc.) can serve them directly instead of through</span>
<span class="c1"># the less performant gunicorn:</span>
pytaku-collect-static<span class="w"> </span>/var/www/pytaku
</code></pre></div> <p>So how does that work? Let&rsquo;s break it&nbsp;down.</p> <h2 id="the-pytaku-executables">The pytaku-* executables<a class="headerlink" href="#the-pytaku-executables" title="Permanent link">#</a></h2> <p><a href="https://python-poetry.org/">Poetry</a> is awesome. Not only does it offer sane dependency management that plays well with the pyenv + virtualenv combo, but it also vastly simplifies building and publishing python libraries. Telling pip to install executables alongside my library is as simple as writing a few lines in my <a href="https://git.sr.ht/~nhanb/pytaku/tree/ff20e51f8c178bf981d80aa3737bf31a1059a506/item/pyproject.toml#L15-21">pyproject.toml</a>&nbsp;file:</p> <div class="highlight"><pre><span></span><code><span class="k">[tool.poetry.scripts]</span>
<span class="n">pytaku</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pytaku:serve&quot;</span>
<span class="n">pytaku-dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pytaku:dev&quot;</span>
<span class="n">pytaku-migrate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pytaku:migrate&quot;</span>
<span class="n">pytaku-generate-config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pytaku:generate_config&quot;</span>
<span class="n">pytaku-scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pytaku:scheduler&quot;</span>
<span class="n">pytaku-collect-static</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pytaku:collect_static&quot;</span>
</code></pre></div> <p>The left hand side indicates the executable file name, while the right hand side declares which function to call. In my example, &ldquo;pytaku:serve&rdquo; points to the serve() function inside&nbsp;src/pytaku/__init__.py.</p> <p>Now that we have easy access to <span class="caps">CLI</span> entry points, let&rsquo;s quickly go over <a href="https://git.sr.ht/~nhanb/pytaku/tree/ff20e51f8c178bf981d80aa3737bf31a1059a506/item/src/pytaku/__init__.py">how</a> each command&nbsp;works:</p> <ul> <li><code>pytaku</code> and <code>pytaku-dev</code> simply exec gunicorn and flask respectively behind the&nbsp;scene.</li> <li><code>pytaku-migrate</code> runs my bespoke migrator script (which is extremely primitive but hey it was a good learning&nbsp;experience).</li> <li><code>pytaku-generate-config</code> uses <a href="https://github.com/lincolnloop/goodconf">goodconf</a> to generate a config template, pre-filling as many values as it&nbsp;can.</li> <li><code>pytaku-scheduler</code> is just a dead simple single-threaded scheduler that I don&rsquo;t recommend for any service that has more than a handful of&nbsp;users.</li> <li><code>pytaku-collect-static</code> leverages importlib.resources.path to get the package&rsquo;s installation path. From there it copies the bundled static assets to wherever you want your nginx to serve. It&rsquo;s basically a simplified version of Django&rsquo;s collectstatic&nbsp;command.</li> </ul> <h2 id="but-why-bother">But why bother?<a class="headerlink" href="#but-why-bother" title="Permanent link">#</a></h2> <p>Lincoln Loop&rsquo;s series of Django-related blog posts were my main inspiration. Central to this idea is <a href="https://lincolnloop.com/blog/using-setuppy-your-django-project/">Using setup.py in Your (Django) Project</a>, which explains both how and why you would want to make your python project pip-friendly. The &ldquo;why&rdquo; boils down to 2&nbsp;points:</p> <ul> <li>You don&rsquo;t want to reinvent package management. Let pip handle the minute details of packaging, distributing, versioning, etc. for&nbsp;you.</li> <li>You no longer need to run python from the source code&rsquo;s path. In pytaku&rsquo;s case, the working dir now only stores the sqlite database file and the json config file, i.e. purely data, completely separate from the source&nbsp;code.</li> </ul> <p>More broadly, the idea of simple distributing/deployment is, in my opinion, often overlooked these days. Fiddly deployment procedures are largely why Docker flourished: our industry just collectively gave up on self-contained software distribution and decided to ship a whole rootfs for each application process instead. Okay, I may be overreacting here, but I think it&rsquo;s at least fair to say that if every webdev shop standardized on shipping Go binaries statically compiled with musl libc, we&rsquo;d probably reach out for Docker less often. When I showed pytaku to a colleague of mine, his first question was essentially &ldquo;Dockerfile when?&rdquo;. Sure, Docker is neat and solves real problems, but how about we strive to avoid, or at least minimize, those problems in the first place? Remember, while container evangelists love harping on about negligible <span class="caps">CPU</span> overhead, they tend to gloss over the storage&nbsp;overhead:</p> <div class="highlight"><pre><span></span><code>$<span class="w"> </span>docker<span class="w"> </span>image<span class="w"> </span>ls
REPOSITORY<span class="w">   </span>TAG<span class="w">        </span>IMAGE<span class="w"> </span>ID<span class="w">       </span>CREATED<span class="w">       </span>SIZE
python<span class="w">       </span><span class="m">3</span>-alpine<span class="w">   </span>bcf864391ba1<span class="w">   </span><span class="m">3</span><span class="w"> </span>weeks<span class="w"> </span>ago<span class="w">   </span><span class="m">45</span>.1MB
python<span class="w">       </span><span class="m">3</span>-slim<span class="w">     </span>66f4843b721f<span class="w">   </span><span class="m">3</span><span class="w"> </span>weeks<span class="w"> </span>ago<span class="w">   </span>122MB
</code></pre></div> <p>And the operational complexity overhead. Did you know that by default Docker <a href="https://www.jeffgeerling.com/blog/2020/be-careful-docker-might-be-exposing-ports-world">completely sidesteps your firewall</a>? That even if you specifically tell it to only listen to a port on localhost, it may or may not still expose it to the whole world? That this remains an <a href="https://github.com/moby/moby/issues/22054">open bug since 2016</a>? This isn&rsquo;t one of those security bogeyman stories either, actual people have been <a href="https://blog.newsblur.com/2021/06/28/story-of-a-hacking/">bitten by it</a>. At this point cloud apologists would probably jump in and point out how this isn&rsquo;t an issue if you&rsquo;re running on <span class="caps">GCP</span> or <span class="caps">AWS</span> because they have another layer of firewall that locks down every port by default that you can setup on their totally usable web console or infrastructure-as-code it in your cloudformations or your terraformses or, actually, do you have a moment to talk about our lord and savior&nbsp;Cthulhubernetes&ndash;</p> <p>But I&nbsp;digress.</p> <p>I guess what I was trying to say is, throwing abstractions over complex procedures is simply shifting the costs elsewhere. Shipping your software in a Dockerfile is fine, but making your distribution so simple that people can easily write a couple of lines of Dockerfile for it by themselves is more valuable. Simple distribution is simple to deploy regardless of whether you&rsquo;re using docker, packer, ansible, pyinfra, podman, nomad, k8s, k3s, an impenetrable shell script some dude wrote 2 years ago who just left the company last month&hellip; or any combination of the above. The point is <strong>you shouldn&rsquo;t be forced to use more heavyweight solutions just because the software is a pain in the butt to setup manually</strong>.</p> <p>And other people <em>have</em> been trying to make python application distribution&nbsp;simpler:</p> <ul> <li><a href="https://shiv.readthedocs.io/en/latest/">shiv</a> bundles everything but the python&nbsp;interpreter</li> <li><a href="https://github.com/indygreg/PyOxidizer">PyOxidizer</a> bundles everything <em>including</em> the python&nbsp;interpreter</li> <li><a href="https://nuitka.net/">nuika</a> actually compiles your python application into an executable, unlike PyInstaller which just generates a self-extracting&nbsp;archive.</li> </ul> <p>We&rsquo;ll get there.&nbsp;Someday.</p> <div class="footnote"> <hr> <ol> <li id="fn:1"> <p>Well actually you still need to <code>apt install python3-apsw</code>, but that&rsquo;s only because apsw <a href="https://rogerbinns.github.io/apsw/download.html#easy-install-pip-pypi">refuses</a> to provide a binary wheel on pypi. It can be replaced by the standard library sqlite3 module anyway - I only picked apsw because it exposes essentially the same <span class="caps">API</span> as the SQLite C library, which helped when I was learning to use SQLite properly for the first time.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p> </li> <li id="fn:2"> <p>Even with the above, pytaku still won&rsquo;t run out of the box because it needs a <a href="https://github.com/nhanb/gae-proxy/">crappy proxy</a> in order to bypass mangasee&rsquo;s strict cloudflare protection. I know it&rsquo;s lame but pytaku is practically a web scraper project and there&rsquo;s no way to make it work reliably without a proxy pool anyway. I hope this doesn&rsquo;t distract you from the point of the article though.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p> </li> </ol> </div> </article> </div> <h2 id="comments">Comments</h2> <div id="disqus_thread"> <button id="showCommentBtn">Show comments via Disqus</button> <noscript><br>(enable JavaScript first though)</noscript> </div> <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    // These need to be defined in the outermost scope, apparently.
    var disqus_shortname = 'nerdyweekly';
    var disqus_identifier = '/posts/i-made-my-python-webapp-pip-installable/';
    var disqus_url = '../../posts/i-made-my-python-webapp-pip-installable/';
    var disqus_title = 'I made my python webapp installable via pip';

    document.querySelector('#showCommentBtn').addEventListener('click', function (event) {
        // Immediate visual feedback is always good:
        event.target.disabled = true;
        event.target.innerHTML = 'Loading comments...';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    });
</script> </div> <footer> &copy; 2013–2023 Bùi Thành Nhân <br> Built with &#9829; and probably too much <a target="_blank" rel="noopener" href="https://www.alambe.vn/products/ca-phe-rang-xay-alambe-sai-gon">cà phê sữa đá</a>. <p class="easter-egg" style="display: none; font-size: .7em; margin: 0; color: var(--bg-color);"> Bored? Try entering the Konami code from your keyboard. </p> <script>
        document.querySelector('.easter-egg').style.display = 'block';
      </script> </footer> </div> <script src="/theme/konami.js"></script> </body> </html>